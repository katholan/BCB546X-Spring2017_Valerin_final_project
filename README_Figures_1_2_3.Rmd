---
title: "README_Figures_1_2_3"
author: "Devin Molnau"
date: "April 25, 2017"
output: html_document
---
#README for Figures 1, 2, and 3
Figure 1 is a multidimensional scaling plot that represents the distance between all samples of Asparagus officinalis as the root-mean-square deviation. This was done to the top 250 most heterogeneously expressed genes in a pairwise comparison.

Figure 2 is comprised of three pairwise analyses gene expression among female, male and supermale garden asparagus (Asparagus officinalis) genes across all lines (8A,8B, 10, 9). Average log fold change (FC) vs average log of counts per million mapped reads, CPM

Figure 3 is a Venn diagram of the differentially expressed genes found in the pairwise analyses.

###import bioconductor and required libraries
```{r}
source("http://bioconductor.org/biocLite.R")
biocLite()
biocLite("edgeR") 
library(edgeR)
```

###Import counts data
```{r}

#read in the gene counts from paper
counts_data<-read.delim("Asparagus.RSEM_genecounts.txt", check.names=FALSE, stringsAsFactors = FALSE)
```

###convert gene count data to DGEList
```{r}
cd<-DGEList(counts=counts_data)
```
###Filtering
Filters transcripts from read counts data. The transcripts that are kept must belong in at least three libraries. Each library contains more than one count per million mapped reads.
```{r}
keep <- rowSums(cpm(cd)>1) >= 3 #filters out lowly expressed genes
cd <- cd[keep, , keep.lib.sizes=FALSE]
```
###Normalized data
Normalizing data takes into the effect of the library size on the samples. Scaling factors are found for the each of the libraries that minimize the log-fold changes between the samples for most genes. 
The calcNormFactor() uses trimmed mean of M values to determine the scaling factors. These scaling factors in turn can be used to find the effective library size. 
```{r}
cd<-calcNormFactors(cd) #normalizes using TMM
```

###Figure 1: Multidimentional scaling 
Figure 1 is a multidimensional scaling plot of all lines
```{r}
colors <- c("black","black","black","darkgreen","darkgreen","darkgreen","blue","blue","blue", "red", "red") #colors for the lines
#MDS plot without legend, but the names indicate line and sex
plotMDS(cd, col=colors, top = 250, gene.selection = "pairwise", main="MDS plot of various lines and sex of Asparagus officinalis") 
```
###Design Matrix
Additive model of sex and line for fitting. This accounts for differences due to line rather than sex in pairwise analysis.
```{r}
#design matrix of sex and line
rm(design)
line<-factor(c(88,88,88,89,89,89,103,103,103,9,9))
sex<-factor(c("XX","XY","YY","XX","XY","YY","XX","XY","YY","XX","XY"))
#sex<-factor(c("female", "male","supermale","female", "male","supermale","female", "male","supermale","female", "male"))
data.frame(Sample=colnames(cd),line,sex)
design <- model.matrix(~line+sex)
rownames(design) <- colnames(cd)
design
```
###Estimating Dispersion
edgeR packaged uses Cox-Reid profile-adjusted likelihood (CR) method in estimating dispersions when there are multiple factors (sex and line, in this case).
```{r}
cd <- estimateGLMCommonDisp(cd, design) #estimates common dispersion
cd <- estimateGLMTrendedDisp(cd, design)#estimates trended dispersion
cd <- estimateGLMTagwiseDisp(cd, design)#estimates tagwise dispersion
```

###Figure 2: Testing for Differential Expression
glmFit() takes gene counts, dispersions, and the design matrix as an input and produces a DGEGLM object as an output. This fits the negative binomial GLM for each gene id.
```{r}
fit <- glmFit(cd, design)
```

Pairwise comparison between Female and Supermale groups. Note that the coef=6 in glmLRT refers to the 6th column on the design matrix, thus comparing Females from the first column to supermales in the 6th column.
Adjust P value using false discovery rate (FDR) method and then determine how many genes are significantly differentially expressed between female and supermale asparagus. 
Pairwise comparison is plotted using plotMD().
```{r}
lrt_FSupM <- glmLRT(fit, coef=6)  #Female VS Supermale
summary(de_FemvsSupMal <- decideTestsDGE(lrt_FSupM, adjust.method="fdr"))
FDR_FSupM <- p.adjust(lrt_FSupM$table$PValue, method="fdr") 
sum(FDR_FSupM < 0.05) #408  differentially expressed genes (462 if not normalized)
plotMD(lrt_FSupM, main="Female VS SuperMale",hl.col=c("blue","red"), bg.col="grey")
abline(h=c(-1,1), col="blue")
```

Pairwise comparison between Female and Male groups. Note that the coef=5 in glmLRT refers to the 5th column on the design matrix, thus comparing Females from the first column to Males in the 5th column.
Adjust P value using false discovery rate (FDR) method and then determine how many genes are significantly differentially expressed between female and male asparagus. 
Pairwise comparison is plotted using plotMD().
```{r}
lrt_FM <- glmLRT(fit, coef=5) #female VS male
summary(de_FemvsMal <- decideTestsDGE(lrt_FM, adjust.method="fdr"))
FDR_FMale<-p.adjust(lrt_FM$table$PValue,method="fdr") #adjust Pvalue
sum(FDR_FMale<0.05) #221 significant differentially expressed genes
plotMD(lrt_FM, main="Female VS Male")
```
Pairwise comparison between Male and Supermale groups. Note that the fifth and sixth columns are Male and Supermale respectively and must be referred to by their position in the design matrix.
Adjust P value using false discovery rate (FDR) method and then determine how many genes are significantly differentially expressed between male and supermale asparagus. 
Pairwise comparison is plotted using plotMD().
```{r}
lrt_MSupM <- glmLRT(fit, contrast=c(0,0,0,0,-1,1)) #Male VS Supermale
summary(de_MalvsSupMal <- decideTestsDGE(lrt_MSupM, adjust.method="fdr"))
FDR_MSupMale<-p.adjust(lrt_MSupM$table$PValue,method="fdr")
sum(FDR_MSupMale<0.05) #27
plotMD(lrt_MSupM, main="Male VS Supermale")
```
###Figure 3: Venn Diagram
Making vectors of the genes that were signficantly differentially expressed in each pairwise comparison.

The following returns a vector called names_of_FSupM_hit that contains all the gene_id names that were significantly differentially expressed between female and supermale asparagus.
```{r}
##Get the names of all of the genes that have a Pvalue<0.05 for FDR_FSupM
total_FDR_FSupM<-length(FDR_FSupM)
total_FDR_FSupM
names_of_FSupM_hit<-c()
counter<-0
for (i in 1:total_FDR_FSupM){
  if (FDR_FSupM[i]<0.05 ){
    counter<-counter+1
    names_of_FSupM_hit[counter]=rownames(lrt_FSupM)[i]
  }
}
names_of_FSupM_hit
num_FSupM_hit<-length(names_of_FSupM_hit)
num_FSupM_hit #408 
```

The following returns a vector called names_of_FMale_hit that contains all the gene_id names that were significantly differentially expressed between female and male asparagus.
```{r}
##Get the names of all of the genes that have a Pvalue<0.05 for FDR_FMale
total_FDR_FMale<-length(FDR_FMale) 
total_FDR_FMale
names_of_FMale_hit<-c() #empty vector
counter<-0
for (i in 1:total_FDR_FMale){
  if (FDR_FMale[i]<0.05 ){
    counter<-counter+1
    names_of_FMale_hit[counter]=rownames(lrt_FM)[i] #adds the gene_id to empty vector if significantly differently expressed
  }
}
names_of_FMale_hit
num_FMale_hit<-length(names_of_FMale_hit)
num_FMale_hit #221 DF genes in Female/Male pairwise comparison
```

The following returns a vector called names_of_MSupMale_hit that contains all the gene_id names that were significantly differentially expressed between male and supermale asparagus.
```{r}
##Get the names of all of the genes that have a Pvalue<0.05 for FDR_FMale
total_FDR_MSupMale<-length(FDR_MSupMale)
total_FDR_MSupMale
names_of_MSupMale_hit<-c()
counter<-0
for (i in 1:total_FDR_MSupMale){
  if (FDR_MSupMale[i]<0.05 ){
    counter<-counter+1
    names_of_MSupMale_hit[counter]=rownames(lrt_MSupM)[i]
  }
}
names_of_MSupMale_hit
num_MSupMale_hit<-length(names_of_MSupMale_hit)
num_MSupMale_hit #27
```
Comparison of differentially expressed genes in Female/Supermale and Male/Supermale pairwise comparison. 
```{r}
###Checks the number of hits between FSupM and MSupMale
FSupM_MSupM<-names_of_FSupM_hit %in% names_of_MSupMale_hit #compares the two vectors of gene names
sum(FSupM_MSupM) #23 common DF genes shared
num_FSupM_MSupM<-sum(FSupM_MSupM) #makes variable for venn diagram
```
Comparison of differentially expressed genes in Female/Male and Female/Supermale
pairwise comparisons.
```{r}
FMale_FSupM<-names_of_FMale_hit %in% names_of_FSupM_hit
sum(FMale_FSupM)#150 differential genes shared between Female/Male and Female/Supermale
num_FMale_FSupM<-sum(FMale_FSupM) #makes variable for venn diagram
```
Comparison of differentially expressed genes in Female/Male and Male/Supermale pairwise comparisons
```{r}
FMale_MSupMale<-names_of_FMale_hit %in% names_of_MSupMale_hit
sum(FMale_MSupMale)#2 DF genes 
num_FMale_MSupMale<-sum(FMale_MSupMale) #makes variable for venn diagram
```
Comparison of significantly differentially expressed gene in Female/Male, Male/Supermale, Female/Supermale pairwise comparisons.
```{r}
FSupM_MSupM_FMale<-names_of_FMale_hit %in% names_of_FSupM_hit %in% names_of_MSupMale_hit
sum(FSupM_MSupM_FMale)
num_FSupM_MSupM_FMale<-sum(FSupM_MSupM_FMale) #0 DF genes shared between all three groups
```
Generating the VennDiagram
```{r}
###Venn Diagram###
install.packages('VennDiagram')
library(VennDiagram)
grid.newpage()
draw.triple.venn(area1 = num_FMale_hit, area2 = num_FSupM_hit, area3 = num_MSupMale_hit, n12 = num_FMale_FSupM, n23 = num_FSupM_MSupM, n13 = num_FMale_MSupMale, 
                 n123 = num_FSupM_MSupM_FMale, category = c("Male vs Female", "Supermale VS female", "Supermale VS male"), lty = "blank", 
                 fill = c("skyblue", "pink1", "mediumorchid"))

```

