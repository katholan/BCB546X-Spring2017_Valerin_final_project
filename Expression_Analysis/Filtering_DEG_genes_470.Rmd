---
title: "R Notebook"
output: html_notebook
---
Filtering the data to get the candidate transcripts for analysis

First we import the edgeR library from bioconductor


```{r}
source("http://bioconductor.org/biocLite.R")
biocLite()
biocLite("edgeR")
library(edgeR)
```

Then we read the database 

```{r}
counts_data<-read.delim("Asparagus.RSEM_genecounts.txt", check.names=FALSE, stringsAsFactors = FALSE) 
```

We select only the rows that have a CPM bigger than 1 in at least three libraries, which should reduced the number of tested genes to 19 986

```{r}
cd<-DGEList(counts=counts_data)
keep <- rowSums(cpm(cd)>1) >= 3
cd <- cd[keep, , keep.lib.sizes=FALSE]
```

If we see the number of rown in the list we get a very close measure of the expected number of genes 

```{r}
nrow(cd)
```
Then we can create the groups that we are going to use for the experimental design
```{r}
group_line<-factor(c(88,88,88,89,89,89,103,103,103,9,9))
group_sex <- factor(c("Female", "Male",	"Super Male",	"Female",	"Male",	"Super Male",	"Female",	"Male",	"Super Male",	"Female",	"Male"))

```

Then we build the design as an additive model, and estimate the three types os dispersion

```{r}
design <- model.matrix(~group_line + group_sex)
rownames(design) <- colnames(cd)

#cd <- estimateDisp(cd, design)

cd <- estimateGLMCommonDisp(cd, design)
cd <- estimateGLMTrendedDisp(cd, design)
cd <- estimateGLMTagwiseDisp(cd, design)

fit <- glmFit(cd, design)

```

Let`s explore a little more the design object. It indicates the experimental design we are using to analyze the data

```{r}
design
```

Therefore, the model takes the intercept as the baseline (Female phenotype), and then each coeficient in the desing corresponds to: (2) line88, (3) line89, (4) line103, (5) Male, (6) Super Male. 

Now the comparisons fem vs sup male and an example of a plot (taking the coef=6 vs 1-female, default)

```{r}
lrt_FSupM <- glmLRT(fit, coef=6)
summary(de_FemvsSupMal <- decideTestsDGE(lrt_FSupM, adjust.method="fdr"))
FDR_FSupM <- p.adjust(lrt_FSupM$table$PValue, method="fdr")
sum(FDR_FSupM < 0.05)

detags <- rownames(cd)[as.logical(de_FemvsSupMal)]
plotSmear(lrt_FSupM, de_FemvsSupMal.tags=detags)
abline(h=c(-1, 1))
```

female vs super male

```{r}
lrt_FM <- glmLRT(fit, coef=5)
summary(de_FemvsMal <- decideTestsDGE(lrt_FM, adjust.method="fdr"))

FDR_FM <- p.adjust(lrt_FM$table$PValue, method="fdr")
sum(FDR_FM < 0.05)
```
male vs sup male


```{r}
lrt_MSupM <- glmLRT(fit, contrast=c(0,0,0,0,-1,1))
summary(de_MalvsSupMal <- decideTestsDGE(lrt_MSupM, adjust.method="fdr"))

FDR_MSupM <- p.adjust(lrt_MSupM$table$PValue, method="fdr")
sum(FDR_MSupM < 0.05)
```

If we sum up all the comparisons results we get 754 DEG, including duplicates
