---
title: "R Notebook"
output: html_notebook
---
Filtering the data to get the candidate transcripts for analysis

First we import the edgeR library from bioconductor


```{r}
source("http://bioconductor.org/biocLite.R")
biocLite()
biocLite("edgeR")
library(edgeR)
```

Then we read the database 

```{r}
counts_data<-read.delim("Asparagus.RSEM_genecounts.txt", check.names=FALSE, stringsAsFactors = FALSE) 
```

We select only the rows that have a CPM bigger than 1 in at least three libraries, which should reduced the number of tested genes to 19 986

```{r}
cd<-DGEList(counts=counts_data)
keep <- rowSums(cpm(cd)>1) >= 3
cd <- cd[keep, , keep.lib.sizes=FALSE]
```

If we see the number of rown in the list we get a very close measure of the expected number of genes 

```{r}
nrow(cd)
```
Then we can create the groups that we are going to use for the experimental design
```{r}
group_line<-c(88,88,88,89,89,89,103,103,103,9,9)
group_sex <- c("Female", "Male",	"Super Male",	"Female",	"Male",	"Super Male",	"Female",	"Male",	"Super Male",	"Female",	"Male")

```

Then we build the design as an additive model, and estimate the three types os dispersion

```{r}
design <- model.matrix(~group_line + group_sex)
rownames(design) <- colnames(cd)

cd <- estimateGLMCommonDisp(cd, design)
cd <- estimateGLMTrendedDisp(cd, design)
cd <- estimateGLMTagwiseDisp(cd, design)

fit <- glmFit(cd, design)

```

now the comparisons fem vs sup male and an example of a plot

```{r}
lrt_FSupM <- glmLRT(fit, coef=4)
summary(de_FemvsSupMal <- decideTestsDGE(lrt_FSupM, adjust.method="fdr"))
FDR_FSupM <- p.adjust(lrt_FSupM$table$PValue, method="fdr")
sum(FDR_FSupM < 0.05)

detags <- rownames(cd)[as.logical(de_FemvsSupMal)]
plotSmear(lrt_FSupM, de_FemvsSupMal.tags=detags)
abline(h=c(-1, 1))
```

female vs super male

```{r}
lrt_FM <- glmLRT(fit, coef=3)
summary(de_FemvsMal <- decideTestsDGE(lrt_FM, adjust.method="fdr"))
```
male vs sup male


```{r}
lrt_MSupM <- glmLRT(fit, contrast=c(0,0,-1,1))
#lrt_MSupM <- glmQLFit(fit, contrast=c(0,0,-1,1))
summary(de_MalvsSupMal <- decideTestsDGE(lrt_MSupM, adjust.method="fdr"))
```

If we sum up all the comparisons results we get 470 DEG




